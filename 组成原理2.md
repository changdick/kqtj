# 组成原理2 RISC-V
## RISC-V汇编语言
先看一组C程序和对应的汇编语言
```c
int A[20];
int sum = 0;
for (int i = 0; i < 20; i++) {
    sum += A[i];
}
```
对应的汇编语言如下
```
add x9 , x8 , x0    # x8为数组A[20]的地址， 把&A[0]存在x9，因为不能动x8，x8之后可能有别的用处
add x10 , x0 , x0   # sum  初始值为0，存在寄存器x10
add x11 , x0 , x0   # i    初始值为0，存在寄存器x11
addi x13 , x0 , 20  # 20是比较的次数，需要先存在寄存器x13，因为后续要用来分支判断，但是分支语句比较只能是两个寄存器比较，比较是不能用立即数的
Loop:
    bge  x11 , x13 , Done   # 如果 i >= 20 跳转到Done。 汇编中进入循环，总是先检查循环是否结束
    lw x12 , 0(x9)          # 读取A[i]的值到x12中， x9寄存器存放的是他的地址
    add x10 , x10 , x12     # sum = sum + A[i]
    addi x9 , x9 , 4        # x9存放地址的，要加上4，4byte是一个字, 得到了 &A[i+1]
    addi x11 , x11 , 1      # i++
    j Loop                  # 无条件跳转到Loop处，形成循环
Done:
```

### RISC-V汇编语言的语法和指令
#### 指令语句的基本格式
一行汇编语言代码表示一条机器指令。每一行语句的格式都是：
```
one   two, three, four
```
依次表示操作名称、操作数1、操作数2、操作数3， 其中操作数1一般是接受运算的结果，操作数2、操作数3是参与运算的数。操作名称和三个参数之间用空格隔开，三个参数之间用逗号隔开。例如：
```
add  x1, x2, x3
```
这是表示加法运算， 和`x1=x2+x3`一个意思。
#### 汇编语言的基本元素
汇编语言中操作的对象全都是寄存器，数据储存在寄存器中，指令作用于寄存器完成运算等操作，对寄存器进行存储、读取等会和内存交流数据。因为寄存器运算快。寄存器是硬件中真实存在的，但也因此数量有限，只有32个。其中一个是x0寄存器，这个x0是硬件实现的0，的它作用就是提供0，因为0在程序中常见所以就用硬件实现，不管对x0寄存器怎么操作它都是0.除了x0以外，还有31个寄存器可用，所以数量有限。  
**x0寄存器里的值永远是0。** 写汇编语句的时候直接用x0来表示0.   
#### 加法、减法指令
加法指令叫`add`, 接上三个寄存器， 即 `add rd,rs1,rs2`。 其中rd表示register destination，就是运算结果存储到的目标寄存器， `rs1`和`rs2`中的s表示source，这两个寄存器存储的就是参与运算的两个数。  
```
add  x1,x2,x3    # 汇编语言的语句
a = b + c;       // 其他语言与之对应的语句，其中变量a 对应寄存器x1， 变量b和c对应寄存器x2和x3
```
减法指令叫`sub`，语法一样是 `sub rd,rs1,rs2`, rs1中的值减去rs2的值的结果，存放到rd寄存器里。
```
sub x3,x4,x5
d = e - f          # x3与d， e与x4， f与x5一一对应
```
如果要做多个数的混合运算，在高级语言是可以一句完成，比如 `a = b + c + d - e`， 在汇编中，每次只能两个寄存器参与运算，所以必须分几步完成。
```
a = b + c + d - e  换成RISCV汇编， bcde分别对应寄存器x1，x2，x3，x4， 运算结果a要存放在x10里

add x10,x1,x2     # 相当于 a_temp = b + c
add x10,x10,x3    # a_temp = a_temp + d
sub x10,x10-x4    # a_temp = a_temp - e

RV汇编中 #后面内容表示注释，和python一样
```
加法指令可以用来复制一个寄存器的值给另一个，比如高级语言中的赋值`b = a`, RISC-V的指令集是尽可能精简的，如果现有指令可以完成的任务，就不会引入其他指令做一样的事情.这个赋值用加法做，`add x11,x0,x10`就把x10里面的值复制到了x11里面，x0是永远存储0的特殊寄存器，就用在了这里。其他例子比如分支比较的指令，只有小于和大于等于，没有小于等于或大于。没有一个专门的按位取反指令，因为按位取反可以用和全1异或来实现。

#### 立即数
立即数就是指直接出现的常数，比如c语言语句`if(i>5)`，这个5就是一个直接出来参与运算的数字，不是存一个变量或者常量的。汇编中直接写出来的这种数字参与操作，就是立即数immediate。用立即数参与运算的操作有专门的指令，立即数加法`addi`,立即数减法没有，因为减去一个数可以用加上相反数来完成，所以只有`addi`，它的语法是`addi rd,rs,imm`,一个目标寄存器，一个参与运算的计算器，一个立即数。
```
addi rd, rs, imm
addi x3, x4, 10        # x4的值，加上10， 结果存x3
```
**立即数0**：0用的比较多，所以直接硬件上实现在了x0寄存器中，所以比如加上0就用 `add x3,x4,x0`。并且x0里的值是硬件实现的，不管怎么对x0操作都不会变。


