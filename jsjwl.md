## 物理层
### 信道容量2个公式
奈奎斯特定理；理想无噪声信道最大数据传输速率为 $2Blog_2M$, 单位b/s，其中B为频率带宽。M为信号状态数/进制数  

香农定理：有噪声信道，已知信噪比为 $\frac{S}{N}$，那么最大数据传输速率为 $Blog_2(1+\frac{S}{N})$  
通常题目会给的信噪比是分贝表示，分贝表示 $=10lg\frac{S}{N}$  


## 数据链路层
数据链路层的功能：组帧、流量控制、差错控制

### 差错控制
#### 差错编码的检错能力
检错能力用**汉明距离**来衡量。**两个等长的字符串**的汉明距离就是编辑距离，就是二者不同的比特数。换言之，一个编码能够通过反转多少位，变成另一个编码。**一个编码集**的汉明距离，就是这个编码集中，2个编码最小的汉明距离。换言之，把其中一个编码错多少位，会变成另一个编码。

检错能力：如果汉明距离是C，那么C-1位的错误都能检查出来。
> 当两个合法码字的最小距离为 C 时，任何 ≤ C-1 位的错误都不会将一个合法码字变为另一个合法码字   
纠错能力：如果汉明距离C=2r+1，那么可以检查出r位的错误。 为什么是奇数？因为当它距离一个码字是r位，距离另一个码字是r+1位，就纠成偏差r位的码字。  

若数据传输时采用<D,EDC>差错编码，其中D为数据，EDC=DD（即复制两份数据），则该差错编码可以纠错多少位，检错多少位？  
这样的一个差错编码，把一个合法码字变成另一个合法码字，得改3位，汉明距离是3，所以检错2位，纠错1位。  

#### CRC循环冗余校验码
循环冗余校验码是通过做模2除法.有一个n次生成多项式，能对应到一个n+1位的二进制除数，并且就需要一个n位的余数。  
双方提前约定好除数是什么。发送方把数据先左移n位（低位补0），再除以除数，得到一个余数，余数拼接到数据后面。（**校验码的生成**，余数就是校验码） 
接收方直接把收到的数据除以除数。如果没错，肯定能整除。  

#### Internet校验和
校验和是IP协议和TCP协议使用的。将数据看作比特流，按照16位分组求和，溢出的进位折到最低位继续加，直到最后得到16位结果，取反后，就是checksum。  

收方验证过程：把校验和在内的数据按16bit分组求和，得到全1就是正确的。

### 流量控制和可靠数据传输
滑动窗口协议既是实现了流量控制，又是实现了可靠数据传输。要想实现可靠数据传输，最基本的原理就是收方发确认消息。最基础的就是停等协议，发送方发一条，接收方收到了之后进行确认，发送方收到确认后可以发下一条。但是这样信道利用率低，所以使用了流水线协议，发送方可以连续发送，接收方有相应的确认机制，这就是滑动窗口协议，具体分为GBN协议和选择重传协议。  
对于2种协议，要记住窗口大小和帧编号位数的要求，以及一种极端特殊情况。  $W_s$表示发送窗口大小， $W_r$表示接收窗口大小。
#### GBN协议
接收窗口大小就是1，累计确认机制。  
发送窗口的大小和帧编号n的关系，满足 $W_s < 2^n$，也就是 $W_s \leq 2^n-1$。    
超时重传：设置一个计时器。这个计时器是和窗口的第一个分组绑定的。发送第一个分组后启动定时器。收到确认后，窗口会移动，会有新的第一个分组，重启定时器。超时的时候，把未确认的全部重传并重新计时。
#### 选择重传（SR）协议
接收窗口：接收窗口是多个，能够缓存收到的分组，对每个分组是单独确认。  
发送窗口：发送窗口也是多个。通常是发送窗口和接收窗口大小相等。不相等的话都不合理。  
超时重传：发送方为每个分组都设置一个计时器，谁超时就重传谁。  
#### 窗口大小要求和特殊情况
两种情况的窗口大小有一个统一的公式，那就是 发窗大小+收窗大小不超过编号个数。 $W_s+W_r \leq 2^n$  
为什么要这样的要求？一种极端情况：接收方收到了发送方发送的所有内容，但是**确认帧全丢失了**。此时收窗已经前进，而发窗还在原地重传。这时候收窗中一定有至少一个帧和发窗里是一样的编号，但是不是同一个帧；收窗期待新的帧，但是发窗发的是此前的重复帧，而接受窗口无法分辨他到底是重复还新的。  
#### 信道（链路）利用率、速率计算
利用率是指发送方传输数据的时间，占总时间的百分之多少。用发送方传输时间除以总时间，通常会是 $\frac{N\times T_{传输}}{T_{传输}+RTT+T_{ACK}}$, 很多题目里面接收方传输确认消息的传输时间是忽略不计的。并且这个值算出来不可能超过1，利用率最大就是1。  
传输速率的计算类似于利用率，但是分子不是传输时间，分子是传输了的数据量。分母是一样的时间。  

### 访问控制
介质访问控制是数据链路层独有的功能，因为数据链路层直接与物理链路交互，必须处理物理层无法解决的共享介质冲突问题。访问控制协议MAC  

MAC协议分为信道划分协议、随机访问MAC协议和轮转MAC协议。  

#### 信道划分协议
信道划分协议其实就是信道的多路复用技术。  
#### 随机访问MAC协议
##### ALOHA协议和时隙ALOHA协议
随机发，并且以信道全部速率发，不监听。这样的效率是低下的，时隙ALOHA效率最高能到 $\frac{1}{e}=0.37$, ALOHA效率最高能到 $\frac{1}{2e}=0.18$  

时隙ALOHA协议：各节点需要时间同步。把时间划分成时隙，每个节点只能在时隙开始的时刻发送。如果一个节点需要发送帧，会在下一个时隙开始的时候发送。如果这个时隙发的帧和人冲突了，是检测得到冲突的。会在下一个时隙以概率p重发，直至成功。  
假设N个节点都要有大量帧要发，那么某一个节点成功发一个帧的概率，是它发送，其他N-1个节点全选择不发送，乘法原理，成功概率 $p(p-1)^{N-1}$  
任意结点成功发送帧的概率，每个节点发送成功概率相加， $Np(p-1)^{N-1}$ 。  
##### CSMA协议
CSMA协议的含义是载波监听，每个节点可以监听信道。又分为1-坚持CSMA协议，非坚持CSMA协议，p坚持CSMA协议。共同点是，在发送之前，监听信道，如果一直监听直到发现空闲并发送，是1-坚持；如果放弃监听，等一会重新开始监听，如果空闲就发送，是非坚持。如果是空闲时以p的概率发送，1-p的概率不发送，等下一个时隙，是p-坚持。

CSMA协议的三种情况，都是发前监听信道来决定是否发送。发送的时候不会监听。但是由于传播有延迟，监听到空闲不代表没冲突。因此改进出了CSMA/CD协议。  
##### CSMA/CD协议
CSMA/CD协议的改进就是“CD”，指的是在发送的时候继续监听信道，检测是否有碰撞。  
为了CSMA/CD协议可以准确的检测出到底有没有碰撞，传输的帧大小有一个最小值的要求，这个要求就是**最小帧长大于2倍的最远两个节点间的时延带宽积**。  
公式表示就是，带宽为 $R$，最小帧长为 $L_{min}$，要求 $\frac{L_{min}}{R} \geq RTT$。
推导假设这样一个情景：最远的两个节点A和B，A给B发数据，在数据即将传播到B的前一刻，B开始发数据，由于A的数据尚未传播到B，B监听到信道空闲所以发出了数据。B马上就会因为监听到A的数据和它冲突而停发，但是B已经传出去的数据会传播到A处，A收到数据的时候，此时距离A开始传输过了一个RTT时间。**要求A能够检测到冲突**，那么A仍应在传输数据。于是A的数据传输时间大于RTT。  

冲突检测的具体实现：有线局域网易于实现：测量信号强度，比较发射信号与接收信号。  无线局域网难实现。因为自身发出的信号强度远高于接收到的其他设备的信号强度，会淹没来自其他节点的微弱信号。  

CSMA/CD协议的效率：效率是指有效传输时间占总时间的比值，总时间包括有效传输时间和附加开销时间。这个公式是个估计公式，把附加开销时间估计为5个的最远传播延迟。  
$t_{prop}$ = LAN中2个结点间的最大传播时延,  $t_{trans}$ = 最长帧传输延迟 , 公式 效率 $=\frac{1}{1+\frac{5t_{prop}}{t_{trans}}}$  

**以太网的CSMA/CD协议**：以太网的MAC协议是采用二进制指数退避算法的CSMA/CD，每次冲突，需要等一个时间后重传。这个等待时间的选取就是二进制指数退避算法，第m次冲突时， 取 $n=min{m,10}$，在 $0,1,\cdots,2^n-1$ 取一个数字K，等待的时间就是K个512bit的传输时间。  
准确来讲，等待K个争用期。在冲突次数小于等于10的时候，指数就是冲突次数；冲突次数超过10次后，指数就是10，不会更大。在0到 $2^n-1$中选取一个数字K，等K个争用期。课本的描述就是512bit的传输时间为1个slot。  以太网规定时间是51.2微秒，这就是10M以太网传输512bit的时间。

#### 轮转访问MAC协议
轮转访问的MAC协议有轮询、令牌传递两种。  
**轮询**：节点分为主从关系，一个主节点，若干个从设备，主节点轮流邀请从属节点。
**令牌传递**：节点是环形，传递一个控制令牌。

### 局域网技术
#### 链路层寻址
链路层寻址使用48位MAC地址，每块网卡都有唯一的MAC地址。48位全是1的是广播地址。  
#### 以太网
物理拓扑结构是星形，逻辑拓扑是总线型。  
以太网是无连接、不可靠的。发送前不建立连接，收到一个帧不进行确认。
##### 以太网帧结构
以太网帧结构在负载数据外封上4个字段，头部加3个，尾部加1个。头部的三个分别是目的MAC地址6B，源MAC地址6B，上层协议类型2B，尾部加的是CRC校验码4B。数据部分要求长度46到1500字节。这是为了满足CSMA/CD协议对最小帧长的要求。   
> 由于10M以太网，把争用期（或者RTT）认为是51.2微秒，那么要求最小帧长512bit，也就是64B。帧封装增加的字段18B，所以原本数据至少46B。  

以太网帧还包括8B前导码，前导码不计入以太网帧长度中。
##### 以太网交换机
以太网交换机是**链路层设备**,对主机透明，即插即用，交换表能自学习。  
每端口的链路，是个独立的冲突域。能隔离冲突域。    
交换方式分为三种：  
1. 存储转发模式：存储，选择性向一个或多个输出链路转发。  
2. 直通模式：收到目的地址（6B）直接开始转发。  
3. 无碎片模式：收到64B后，才开始转发。  
以太网交换机的转发过程中，能根据收到的包，自学习交换机端口和MAC地址的关系。但是如果还不知道，就会用泛洪的方式转发。  

#### 虚拟局域网 VLAN
通过交换机，把实际上一个LAN划分成几个VLAN，每个VLAN就好像独立的LAN在工作。  
为什么需要VLAN？ 流量隔离，灵活成员，广播域隔离  
VLAN帧： 6-6-4-2-N-4 的结构，比以太网帧插入了4B的VLAN标记。


## 网络层
### IP协议
IP头部长度：20B是固定的部分。  3个长度字段单位不同： 首部长度4位以4字节为单位（所以首部长度最长60B），总长度2字节，以字节为单位，片偏移量13位，以8字节为单位。  

几种特殊IP地址：  
前8位是127的IP地址，即127.开头的IP地址，是环回地址，不应该出现在互联网上。  
全0的IP地址：在本网内表示自己机器。  
网络号为0，主机号是特定的：表示本网络内特定主机  
主机为0：表示一个网络。  
主机号全1：表示广播地址，广播给整个目标网络。   
全1的IP地址：对本网络广播。  
路由表中全0的IP，并且子网掩码全0：默认路由，一般通互联网  
**小心私有IP地址**:网络号为10的， 网络号为192.168.0和192.168.255的， 网络号为172.16和172.31的。  不应该出现在互联网上，需要NAT 。  




### IP相关协议
#### ARP协议
ARP协议用于已知IP地址，得到MAC地址，只用在网络的内部。  
单一局域网内：广播→回应→缓存
#### ICMP协议
ICMP协议报文分为**两类报文**，ICMP差错报告报文和ICMP网络探寻报文。（差错报告报文和询问报文）  
##### 差错报告报文 5种 和对应的使用场景
1. 目的不可达  细分为端口不可达、主机不可达等。路由器或主机无法交付数据报，向源点发不可达报文。  
2. 源抑制  因为**拥塞而丢包**,向源点发送源抑制报文，限制源的发送速率。  
3. 超时    因为发现**TTL为0**，所以向源点发送超时。或者是因为**分片重组超时**，终点不能在规定时间内收到一个数据报的全部分片并重组，需丢弃已收的全部数据报片并发送超时报文。
4. 参数问题 因为发现IP首部语法有错或者语义异常。**IP首部不合法**  
5. 重定向  路由器发现源主机发送数据报的路径并非最优，通知源主机改用更优路由。主机下次会把数据报发给别的路由器。
##### 询问报文 2组
1. 回声请求和应答报文（Echo、Reply） 使用场景是ping命令，测试源主机与目标主机之间的连通性。注意ping命令工作在应用层，并且没有传输层，直接使用网络层的ICMP。  
2. 时间戳请求与应答报文  用同步源主机与目标主机的时钟，或测量网络往返时间（RTT）。  
##### 不发送ICMP差错报告报文的情况 4类
1. 对ICMP差错报告报文不发送ICMP差错报告报文  
2. 对多播地址的 IP 数据报不产生差错报告  
3. 分片数据报的非首片不产生差错报告 。 意思就是如果不是第一个分片，就静默不处理。非首片分片的错误不触发即时 ICMP 报告。  
> 中途差错，如果发现是首分片，是会报告的。如果发现是非首分片，是不会报告的。当首分片无差错到达而非首分片出了差错，就得等最后报告超时  
4. 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的IP数据报不发送ICMP差错报告报文.  
总之：本身是差错报告报文、多播IP、分片IP数据报的非首片、特殊IP地址四种情况不发ICMP差错报告报文。  

#### DHCP协议
主机新加入一个网络时，动态分配一个IP地址。 DHCP协议是**应用层协议**。建立在UDP协议基础上。  
DHCP协议的过程是**4条报文**，需要获得IP地址的主机是客户端，网络里面有DHCP服务器。  
> 客户端/服务器模式肯定是客户端主动发起。所以是主机先发消息。来回一共4条。  

4条报文是 DHCP discover， DHCP offer , DHCP request, DHCP ACK.  
注意4条消息全是广播的方式来交互。目的地址全是255.255.255.255。因为客户端不知道服务器地址，所以只能对网络广播。在DHCP的4条报文交互完成前主机根本没有这个网络的IP地址，所以服务器也只能广播。  
#### NAT
NAT使用IP地址和端口号来标识一个地址，完成地址映射。对于进入网络的包换目的地址，出网络的包换源地址。  

### 路由算法和路由协议
路由算法有距离向量算法和链路状态算法，分别使用的底层算法是bellmanford算法和dijkstra算法，分别对应路由协议中的RIP路由协议和OSPF路由协议。  
链路状态算法：通过“链路状态广播” ，所有节点都拥有一样的全局状态，独立使用dijkstra算法算出最优。每个结点拥有相同的信息。  
距离向量算法：和邻居交换距离向量，等收敛。特点是收敛慢。好消息传播快，坏消息传播慢。  

层次路由也是路由算法。根据层次路由，有了自治系统AS的概念。互联网分为多个AS。AS内部有路由协议，叫做**内部网关协议（IGP）**，AS间也有路由协议,叫做EGP 外部网关协议 。  

#### RIP协议
RIP协议用跳数衡量代价，跳数为16是个特殊值，认为是无穷大。  
RIP是应用层协议，下面是UDP协议。  

#### OSPF协议
OSPF协议用泛洪法，通告局部状态，能迅速让每个结点得到全局状态，使用dijkstra算法算出最小代价，构建路由表。  
OSPF下面是IP协议。  

#### 边界网关协议 BGP
BGP是应用层协议，下面是TCP协议  
BGP会话：两个AS的发言人交换BGP报文，通告**去往不同目的前缀（prefix）的路径**,也叫**路径向量**。  
4种报文：  
OPEN ： 和peer建立TCP连接。  
UPDATE： 通告一条新路径，或者撤销。  
KEEPALIVE：保活连接。  
NOTIFICATION：用来做差错报告和关闭。  





## 传输层
传输层的功能：端到端传输，复用和分用。  
> 复用和分用，指的是同一个主机的不同端口。复用是不同端口都能发送，分用是主机接收后分发给相应端口。  

### UDP协议
UDP是无连接、不可靠的，首部8字节，2字节源端口，2字节目的端口，2字节总长度，2字节校验和。 UDP校验和可以不使用，直接置为0.  
UDP校验和还需要加上伪首部来计算。  
应用：常用于流媒体，能够容忍丢失、追求速率的场景。  DNS是建立在UDP之上的。  

### TCP协议
TCP协议有连接并且可靠，保证按顺序到达。是点对点全双工的（只能一对一，不能广播。全双工说明数据可以双向流动。）    
TCP协议有流水线机制，发送的流水线窗口大小由流量控制和拥塞控制的结果共同决定。  
TCP面向字节的，TCP的序号就是对每个字节来进行编号的。  
#### TCP可靠传输
可靠传输指的的就是对收到的每个字节都要进行确认。只有收到确认，才能认为此前的一个发送是成功的。  
为了可靠传输，TCP有序号和确认序号。  
发送的每个有效字节都是有一个序号的，每次发送的时候，序号seq就是这个段的首字节的序号。发送完后，会将序号进行更新，加上这一次发送的字节数。seq += n ，n就是数据的字节数。  
对每个消息确认都会有一个确认序号，确认序号为n，说明序号直到n-1以前（小于n）的都收到了，接下来期待对方发送序号为n的数据。  
双方的序号是独立的，序号只和自己选的初始值和自己发送了的数据有关，确认序号只和对方的序号有关。   

TCP是单一计时器和累计确认的。  （类似于GBN）  

重传：2种重传，一种是计时器超时了，要重传。另一种是**快速重传**：连续收到3个重复ACK（最先收到的那个不算），直接重传。  


#### TCP连接控制
##### TCP连接建立过程
TCP连接建立一定由客户端发起。称为三次握手。  
1. 客户端先发SYN消息。  
2. 服务器端回复ACK+SYN消息。  
3. 客户端回复ACK消息。这个消息可以直接携带数据。  
双方认为连接已经建立的时机：都是在收到对方的ACK后，认为连接已经建立。  
##### TCP连接关闭过程
TCP关闭连接，客户端和服务器都可以主动提出关闭。过程称为4次挥手。假设是客户端主动提出关闭：   
1. 客户端发FIN给服务器。  
2. 服务器收到FIN，立刻回复ACK。  （客户端接到这个消息后 从FIN wait 1状态到fin wait2状态，为什么要区分？因为fin wait1时，客户端不知道服务器到底收没收到FIN，如果超时，要重传FIN的；fin wait2 说明确信服务器端已经收到了FIN，只需要等FIN消息）
3. 服务器发送剩余信息后，发送FIN。  
4. 客户端收到FIN后，发送ACK。 之后，客户端进入TIME_WAIT状态，等待2个段的最大生存时间 2MSL后释放连接。 服务器端收到ACK直接释放连接。（客户端不保证ACK能够发到服务器端，所以延时等待，如果ACK丢失了，服务器久久没收到ACK，会再发FIN）  



#### TCP流量控制
TCP流量控制是接收方限制发送方的发送速率。接收方设置缓冲区，缓冲区剩余大小是窗口大小，窗口大小作为回复的TCP头部中窗口大小字段给回发送方，发送方收到接收窗口大小后，调整发送窗口大小。    
缓存中的可用空间(spare room)= RcvWindow= RcvBuffer-[LastByteRcvd -LastByteRead]， 这个其实就是缓冲区大小减去收到但还在缓冲区里未处理的数据量，就是接收窗口大小。  

#### TCP拥塞控制
TCP拥塞控制是发送方通过感知网络拥塞程度，自己调整发送速率。发送方感知网络拥塞程度，就是通过丢包来感知，具体是通过超时和重复ACK来感知。超时和3次重复ACK说明网络拥塞导致丢包，于是对拥塞窗口做出一定调整。否则就试探扩大拥塞窗口。   

拥塞窗口的增加有两种姿态，一种是线性增长，每过一个RTT，拥塞窗口增加1个单位，这也叫做拥塞避免。一种是指数增长，每过一个RTT，拥塞窗口翻倍，这种叫慢启动。  

拥塞控制过程：拥塞窗口的初始值是1，同时阈值也要有一个初始值。窗口大小小于阈值，首先慢启动阶段，每个RTT翻一倍。窗口大小达到阈值，进入拥塞避免阶段，每个RTT增加1。直到某个时刻，发生了丢包事件。把阈值设置成此时拥塞窗口大小的一半。并且根据丢包类型调整拥塞窗口：如果是三次重复ACK，拥塞窗口减半，之后直接是拥塞避免阶段（称为快速恢复）。如果是超时，拥塞窗口直接回到1，重新开始慢启动。    

慢启动的另一种表述：用时间RTT来观察慢启动的变化，它是指数型增长。也可以用接收到的段的确认数来表述：每收到对一个段的确认，拥塞窗口加1。    
拥塞避免阶段： 用时间RTT来表述就是线性增长。用收到的段的个数来表述：每收到拥塞窗口大小个段的确认，拥塞窗口加1.  




## 应用层
**网络应用的模型/结构**：C/S架构（客户端-服务器结构）、P2P结构、混合结构
### DNS
DNS解决域名到IP地址的映射。DNS是分层次的、分布式的。  分布式层次式数据库    
层次：根域名服务器、顶级域名服务器、权威域名服务器  
本地域名服务器：主机遇到不知道IP地址的域名，首先查询本地域名服务器。本地域名服务器如果查不到，此后的查询也是本地域名服务器进行查找，最后返回给到主机。查询方式又分递归查询和迭代查询。

DNS资源记录（RR）：通常有（name, value, type, ttl）四个值。根据type不同，有不同含义。  
type的值为A：是个地址记录，name是主机域名，value是IP地址。   
type的值为cname：是个别名记录，name是个别名，value是真实域名。  
type的值为NS：name是一个域（例如edu.cn）,value是对应的权威域名服务器的主机域名。    
type为MX：name是邮件服务器别名，value是邮件服务器名  


DNS下面是使用UDP。除了DNS外，其他都是TCP。  
### FTP
两个端口：服务器21端口是控制连接， 服务器20端口是数据连接。  这种被称为带外传送。   
### 电子邮件
邮件传送协议SMTP，端口号25。 客户端发送给服务器，服务器之间发送，都是SMTP。  
邮件读取协议：客户端从邮件服务器取邮件，用POP3协议、IMAP协议，也可以http协议。

### HTTP协议
网页对象寻址：用url 统一资源定位器  
使用TCP来传输，但是HTTP本身是不维护连接状态的  
HTTP1.0：非持久连接，每个TCP连接传输最多一个对象。每响应一个消息，响应时间：2RTT +响应消息发送时间   
1.0版本优化思路：可以在第一个TCP连接请求index.html页面后，对每个对象并行发起http请求。  
HTTP1.1：持久性连接。  又分为非流水和流水的，非流水的是逐个请求对象，收到后再请求下一个。流水的，连续请求多个对象。  

cookie：服务器让客户端设置，cookie保存在客户端主机上。cookie对应的数据保存在服务器的数据库里面。客户端的请求带上cookie，服务器就能从数据库里找到对应的状态。  

### P2P文件分发
#### C/S架构的情况
C-S架构文件分发时间：  服务器上传文件的时间，和结点下载文件的时间。
服务器需要将文件发给每个客户端，总共发送NF大小的数据，上传带宽限制了总时间，所花时间 $\frac{NF}{u_s}$  
最慢的客户端决定了最快完成时间，客户端下载时间 $\frac{F}{d_{min}}$  
分发时间为二者大的那个。

#### P2P的情况
服务器必须至少上传完整文件一次，才能启动传输。需要时间 $\frac{F}{u_s}$  
最慢的节点下载速度限制。  客户端下载时间 $\frac{F}{d_{min}}$   
系统总上传能力是服务器上传带宽加上所有节点的上传带宽。所有节点也能参与上传，总共上传NF数据量。   最后就是 $\frac{NF}{u_s+\sum d_i}$  
总耗时为3者最大值。  

