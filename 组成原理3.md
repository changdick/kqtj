# 组成原理3 存储器

## 存储器的基本概念
我们学习的存储器的内容，包括主存储器，主存储器就是随机存储器RAM，分为SRAM和DRAM，分别学习他们的存储原理和例子。还学习存储信息的校验，尤其是汉明码校验。还有高速缓冲存储器。 

### 存储器的技术指标
**存储容量**：存储容量是存储器中能存储的0和1的个数。单位可以是bit也可以是字节Byte。单位还有KB，存储器这里讨论的这个K，就是2的十次方的意思。在题目中会遇到1K×8位的存储芯片，1k指的就是有10根地址线进行选址，所以有正好 $2^{10}=$1k个的不同地址，也就是有1k个寻址单元，而每个单元存储8个数字（8 bit），就是1k × 8。

**寻址单位和寻址范围**：寻址可以按字节为单位寻址，也可以按字为单位寻址。字长可以是16位也可以是32位，rV32就是按字节为单位寻址，并且字长32位。但是字长是看题目假设的，寻址单位也是题目可以假设的。但方法是一样的。用不一样的寻址单位，会有不同的寻址范围。给定存储容量的芯片，寻址单位用的大，能编出来的地址就小，寻址范围就小。快速的算这个要用2的次方。例如给定16MB（ $2^{27}$）的存储器。我们把 $2^{27}$拆分：
1. $2^{24}\times2^{3}$  字节为单位寻址 寻址范围是 $2^{24}$即16M，地址可以编到16M， 总容量是16MB。 如果要换位为单位，那容量是128M位。

## 主存储器

### 存储器与CPU连接 （例题）
首先需要清楚存储器这个器件有哪些信号要连接的。
#### 半导体存储芯片的一般结构 
地址线：用于选择和外面交互的存储单元。（存储器内部有线选法和重合法寻址，实际上用重合法寻址）  
数据线：数据线是双向的，进行数据读写。  
片选线：片选线给有效信号，表示选中了这一片存储芯片，它才有效工作。  
读写控制线：用于控制读写。
#### CPU的线和连接要点
CPU参与连接的线只有4种，访存控制信号 $\overline{MREQ}$,地址线，数据线，读写命令线。  

要点：
1. CPU的地址线比存储芯片的地址线多，所以不是一一对应的，CPU的线多出来的整合生成成片选信号。地址看的是CPU的地址线。
2. 数据线的连接：一切以CPU的数据线条数为准，CPU的数据线有几条，意味着寻址单位是多少位，一般CPU数据线条数多于存储器的数据线位数，这意味着存储器要用多片，进行位扩展。
3. 片选线的连接：按照解题步骤做，会发现低位用于地址线后，使用不同芯片的，CPU地址线高位是不一样的，不一样的就拿来生成片选信号，接到存储芯片的片选线上。而访存控制信号一定要参加到片选信号的生成中。
4. 读写信号连接：CPU读写命令线可以直接连到存储芯片读写控制端。
5. 存储芯片的选择： 用户程序用RAM，系统程序用ROM

#### 例题
例1： 设CPU有16根地址线，8根数据线，访存控制信号 $\overline{MREQ}$低电平有效，读写信号 $\overline{WR}$高电平读、低电平写，提供以下几种存储芯片：RAM ：1K×4位；4K×8位；8K×8位；  ROM ：2K×8位；4K×8位；8K×8位。 还提供74L138译码器和各种门电路。 给CPU连接存储器，要求 1）主存地址空间分配： 6000H-67FFH为系统程序区， 6800H-6BFFH为用户程序区。 

解析： 有固定的解题步骤。按照步骤来做题。此题的储存地址范围，是题目提供给我们的，主存地址分配，题目提供了。而寻址单位，即一个地址存多少位，是CPU数据线数提供的。  
（1） 写出对应的二进制地址码。
```
0110 0000 0000 0000
...                       系统程序区
0110 0111 1111 1111

0110 1000 0000 0000
...                       用户程序区
0110 1011 1111 1111

```
（2）分析寻址范围，确定芯片类型和数量  
数据有几位，看CPU的数据线，所以读写都是8位作为单位的。地址范围有多少，就看写出来的二进制码。我们看系统程序区的，A0到A10一共11位有变化，所以这就是地址范围，11根地址线，就是2的11次方，就是2K， 所以系统程序区，是2k × 8位。 刚好有提供了一个2K×8位的ROM芯片，就可以直接使用。  
同理，看用户程序区，地址是10根线在变化，所以是1K×8位，所以要在RAM中，选两片1K×4位的，进行一个位扩展。  

（3）分配地址线  
地址线有16条，但我们真正分配给存储芯片地址线的，分别是11条和10条。所以会有多出来的。这时候要分配，哪些作为存储器地址线，哪些作为片选信号。这题高5位就是作为片选信号（实际上只有A11体现了不同），A10-A0给系统程序区那块芯片，A9-A0给用户程序区那两块芯片。如果我们要用74L138译码器，那选择控制信号只有3条，我们可以分配成：A15、A14当使能信号，A13-A11当选择控制端。  

（4）确定片选信号
根据选择好的CPU地址线，设计出片选信号。比如A13-A11连到了三八译码器的选择控制端，那实际上两个值是100和101，就把Y5和Y4的信号连出来，分别当片选信号。但是这里对于1k×4位的那两个芯片，似乎A10信号没有用上。可以把A10和Y5的信号综合一下，过一个与门，只有两个都是0，才能给到片选信号给芯片。  

例2： 假设同前，要求最小的 4K为系统程序区，相邻8K为用户程序区。  

解析：题目同样给我们提供了寻址范围，他说的最小4K，只的是从0开始算最小。 
（1）写出二进制地址码：4k就是 $2^{12}$，所以要调动12根地址线，可以快速得到是低12位从全0变到全1。    
```
0000 0000 0000 0000
...                      系统程序区 4K×8位
0000 1111 1111 1111
0001 0000 0000 0000      这是用户程序区那8K的开端
...                      用户程序区 8K×8位
0010 1111 1111 1111      算出这个，用了个技巧：按住低10位不动，给前面的把A10当作“1”，给前面加上8，再减1。

0001 0000 0000 0000
...                       4K×8位
0001 1111 1111 1111              用两个在按照寻址范围扩展（字扩展）
0010 0000 0000 0000
...                       4K×8位
0010 1111 1111 1111

```
（2）确定芯片类型   
系统程序区是4K×8位，用户程序区8K×8位，那系统程序区可以直接有对应的ROM。（用户程序区，完全可以直接用8K乘8位的来做。但可能是想地址线分配好分，答案使用2个4K×8位）。那么两个4K×8位，要再细分一下地址范围。   
（3）分配地址线   
可以统一把低12位用作连接存储器的地址线，高4位用来生成片选信号。   
（4） 确定片选信号   
可以把A14-A12用来接到38译码器的3个输入，那么输出Y0、Y1、Y2刚好就分别用于寻三个地址。A15可以接给使能。访存控制信号是肯定要作为使能信号接译码器上。译码器多出来一个使能信号而CPU以及连满了，可以直接接高电平。


### 存储器校验
编码的最小距离： 从一个合法编码变成另一个合法编码，需要改变的最少位数。   
编码的最小距离减去1，肯定大于等于这种编码方式的检错位数+纠错位数。  
#### 汉明码编码（例题）
汉明码：对于一个n位数据，添加k个校验位，组成一个新的编码。这个编码传输后可以按约定（看是约定的奇校验还是偶校验）进行校验和纠错。   

方法： 先看k是多少。 要添加的k符合一个公式： $2^k \geq n+k+1$， 原数据4位，要加3个校验位，组成一个7位的新数据。 

写汉明码：（1）先标明位数，1，2，4这样的 $2^i$的位置，是校验位的位置，先空着，把原数据依次填到非校验位上。（2）看约定的是**奇校验还是偶校验**。（3）按组依次确定校验位是多少。凡是二进制是 xxx1的是第一组， 凡是二进制xx1x的是第二组。因此，四位的情况，1，3，5，7是第一组，如果是偶校验，就看1，3，5，7位有几个1，确定第1位的数字，使得第一组的1的个数为奇数。再看第二组2，3，6，7，确定第2位是什么。  

对已有汉明码进行校验与纠错：（1）看约定的是什么规则。比如是奇校验。 （2）按组依次检查，是不是符合要求。如果一个组不符合要求，就记这个组所对应的位数是1。比如第一组的数字是xxxx1，那就是最低位记1。比如第三组对应数字x1xx，那第三组不和要求，第三位记1。符合要求的组，它对应的位置记0。检查完后，看到的数字是什么，就是那一位错了。（3）纠错：如果发现错的刚好是校验位，可以不纠错。直接把真数据位取出来即可。  

**例题1  求 0101 按 “偶校验” 配置的汉明码**    
解析：至少需要3位校验位。所以准备7位。
```
1 2 3 4 5 6 7
----------------     第一步， 填入非校验位
    0   1 0 1

1 2 3 4 5 6 7
----------------     第二步，检查第一组1，3，5，7，1的个数已经是偶数，所以第1位为0.
0   0   1 0 1

1 2 3 4 5 6 7
----------------      检查第二组2，3，6，7，1的个数是奇数，所以第2位是1.
0 1 0   1 0 1


1 2 3 4 5 6 7
----------------      检查第三组4，5，6，7，1的个数已经是偶数，所以第4位是0.
0 1 0 0 1 0 1
```
从而得到答案是0100101.

**例题2** 给定汉明码，求传输的信息是什么。已知接收到的汉明码为 0100111。   
解析：先检查有没有错。  
P1 = 0  
P2 = 1  
P4 = 1  
所以说有错，第110位也就是第6位错了，正确的汉明码是0100101，第1，2，4位是添加的校验位不算，传输的信息就是0101.  

**例题3** 写出偶校验配置的汉明码0101101的纠错过程。
P4 = 4、5、6、7位的异或 = 1   
p2 = 2、3、6、7位的异或 = 0   
p1 = 1、3、5、7位的异或 = 0   
因此，汉明码出错在第4位，可以不纠错。  

## Cache
### Cache映射和主存地址字段设计题
Cache的三种映射方式，对应着主存的地址字段格式：  
直接相联映射： 主存字块标记、Cache字块地址、块内地址  
全相联映射：主存子块标记、块内地址  
组相联映射：主存字块标记、组地址、块内地址  

主存和Cache中的块一定是完全一样的，根据题目提供的寻址单位和块大小，确定块内地址位数。再结合题目给的Cache容量，确定Cache块的数量。
### Cache的命中率、效率
cache的命中率，看名字就想得出来。  
cache的平均访问时间（或者相比没有cache的访问时间，有cache时的访问时间）， 把cache一次访问的时间和主存一次访问的时间，按命中率加权，也很好想。  
cache的访问效率： $\frac{t_c}{t_a}$ 其中分子是cache一次访问时间，分母是平均访问时间。

## 虚拟存储器
### TLB、Page、Cache三种缺失可能的组合情况
合法的一共5种，**TLB命中，Page绝对命中**。TLB缺失，Page可能命中，也可能缺失。 Page命中说明信息在主存。
