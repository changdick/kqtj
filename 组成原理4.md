# 组成原理4 总线和IO
## 总线
### 总线控制
总线控制中分为总线判优控制和总线通信控制。
#### 总线判优控制
总线判优控制分为集中式和分布式，集中式中的三种方式：链式查询方式，计数器定时查询方式、独立请求方式。  

**链式查询方式**：三条控制线，BR、BS、和BG，设备有请求时向总线控制部件发总线请求BR，总线控制部件通过总线同意信号BG依次查询（链式，顺序固定）各个设备，当到达第一个有请求的设备，就发出总线忙信号BS，该设备获得总线控制权。**优先级固定**，**单点故障敏感**，响应慢，优先级低的设备很难获得请求，容易扩充。  
**计数器定时查询方式**：和链式查询一样有BR和BS，没有BG而是增加了设备地址线，**设备地址线的根数** $log_2n$向上取整。优先级可变，对电路故障不敏感，控制较复杂。  
**独立请求方式**：每个设备都有各自的BR和BG，独立发送请求，**响应速度快**，在总线控制部件内部进行排队逻辑，**优先级灵活**。但要用2n根控制线。

#### 总线通信控制
总线通信控制方式为了解决通信双⽅如何协调配合的问题。  
总线周期：完成⼀次总线操作的时间。分为四个阶段： 申请阶段、寻址阶段、传输阶段、结束阶段。   
通信的四种方式：同步通信、异步通信、半同步通信、分离式通信。
1. 同步通信：双方由**统一时标**控制数据传送。（仅适合于总线长度短，各功能模块存取时间相差不大的情况，必须按最慢的设备定时）。
2. 异步通信：采⽤应答方式（握手方式），有不互锁方式、半互锁方式、全互锁方式三种。
3. 半同步通信：有统一时标，同时**增加一条 “等待”响应信号线**，从模块可以给出wait信号给主模块，由于等待信号的存在，**允许不同速度的模块和谐工作**。
4. 分离式通信：**充分挖掘系统总线每个瞬间的潜力**。分成两个子周期，两个模块都可以申请总线占用，通信过程是同步通信。总线的利用率高。

## 输入输出系统 I/O
IO设备与主机交换信息有三种方式：程序查询方式，程序中断方式，DMA方式。这个过程需要使用到IO接口。  
### 接口的功能和组成
接口一共四大功能：选址，传输命令，传输数据，反应设备状态，四大功能各自对应了接口的组成部分。同时对应接口对外的4种线。设备选择线、命令线、数据线、状态线。
1. 选址，对应有设备选择电路。
2. 传送命令，对应有命令寄存器、命令译码器。
3. 传送数据，对应有数据缓冲寄存器DBR。
4. 反应设备状态，对应有完成触发器D，工作触发器B等。
### 程序查询方式
CPU 每时每刻不断查询 I/O 设备是否准备就绪。如果没准备就绪，CPU就原地踏步地等。  
接口电路：最基础。工作流程：CPU先选中，之后启动信号来，然后D置0且B置1，设备工作。数据存入DBR，工作完毕，D置1且B置0，通知CPU准备就绪。随后CPU读走DBR里的数据。  
### 程序中断方式
设备准备的时候，CPU可以并行地执行其他程序。在电路组成上，需要添加中断请求触发器、中断屏蔽触发器、排队电路、中断向量地址形成部件等。
#### 程序中断方式接口电路
##### 1 中断请求信号的生成
中断请求触发器（向CPU给出INTR信号，INTR=1表示给出请求）  
中断屏蔽触发器（储存MASK信号，MASK=1表示被屏蔽，不应给出请求）  
当设备准备好，D=1后，用D、MASK信号生成INTR信号。D=1且MASK=0，则INTR=1。  
##### 2 排队器
多个设备同时给出中断信号，CPU只能响应一个，所以需要判优（或者排队）。可以用硬件方法，或者软件方法。硬件方法比如链式排队器。
##### 3 中断向量地址生成
排队器给出的所有请求信号，是one-hot的，通过中断向量地址形成的部件（设备编码器），做一个编码，得到的是向量地址。CPU通过向量地址可以找到一条跳转到中断服务程序的**入口地址**的**跳转指令**，通过执行这个指令去到中断服务程序的**入口地址**。（跳两次）

向量地址是硬件方法，还能用软件查询法找中断程序入口。
#### 程序中断响应过程
CPU响应中断的条件：有一个允许中断触发器EINT。EINT=1，可以响应中断。  
对EINT，有两个指令：开中断指令，将EINT设置为1。关中断指令，将EINT设置为0。  
CPU 响应中断时间：一定是每条指令执行阶段的结束时刻。

CPU响应中断后，进入**中断周期**，会由硬件自动执行**中断隐指令**。  
**中断隐指令**：做3件事情。
1. 保护程序断点：将断点进栈，或存特定地址。
2. 关中断。
3. 寻找中断服务程序入口地址。（向量地址→PC）

在中断服务程序阶段，中断服务程序的流程是：保护现场、中断服务（设备服务）、恢复现场、中断返回。  
保护现场：程序断点在此前已经由中断隐指令保护过了，还需要把寄存器进栈保护。    
中断返回：有中断返回指令。   
**开中断的位置**：在设备服务前开中断，可以嵌套中断（多重中断）。在中断返回前的时候开中断，单重中断。  

#### IO中断中软硬件技术的应用
中断请求判优，可以用硬件排队器，也可以用软件判优。  
中断服务程序的入口，可以用硬件向量法，也可以用软件查询法。  

### DMA方式
DMA方式与主存交换数据有三种方法：停止CPU访问主存、周期窃取（周期挪用）、DMA与CPU交替访问。  
1. 停止CPU访问主存：I/O设备需要传输数据时，DMA接口要求CPU放弃总线控制权，等数据传输结束后，再交回总线控制权给CPU。缺点：I/O设备在传输两个数据之间的准备时间往往超过了一个存取周期，**CPU没有充分利用主存**。
2. 周期窃取：每当IO设备发出DMA请求时，向CPU挪用总线占用权一个或几个存取周期。
3. DMA与CPU交替访问：每一个CPU工作周期前半段DMA访存，后半段CPU访存。

## 其他内容
### 计算机体系结构中8个伟大思想
面向**摩尔定律**设计、使用**抽象**简化设计、加速**经常性**事件、通过**并行**提高性能、通过**流水线**提高性能、通过**预测**提高性能、**存储层次**、通过**冗余**提高可靠性。  
> 并行在存储（调整主存结构以提高访存速度）、io中都有涉及，流水线和预测在cpu设计中都有。

### 冯诺依曼架构计算机
冯诺依曼架构是以运算器为中心，数据和指令以同等地位存储在存储器中。而哈佛架构是指令存储器和数据存储器分开，区别就是**程序空间和数据空间是否是一体的**。哈佛架构是分开的，允许同时取指和取数。

### 课程中涉及的指标
涉及的数字单位： k是10的3次方， M是10的6次方（百万），G是10的9次方。 但他们与B相连，也就是表示存储容量而不是数字的时候，k是2的10次方，M是2的20次方。 

CPI 周期数/指令    
MIPS 百万条指令/秒    
主频 指CPU的时钟频率，单位Hz、GHz， 也就是 $s^{-1}$
时钟周期 主频的倒数，单位s

带宽/吞吐率：指单位时间完成的任务数量。具体还要看用在哪里。存储带宽 单位时间内与主存交换的二进制信息量，单位Byte/s.  

#### 存储器的指标
存储器的带宽：单位时间内存储器存取的信息量。 单位可以是（B/s， bit/s， 字/s）

#### 总线的指标
总线也有时钟频率、传输周期、总线带宽（MBps）等。

例1 假设总线的时钟频率为 100MHz，总线的传输周期为 4 个时钟周期，总线的宽度为 32 位，试求总线的数据传输率。若想提高一倍数据传输率，可采取什么措施？   
每秒100M个时钟周期，传输周期是4个时钟周期，所以每秒25M个传输周期，总线宽度32位也就是单次传输32位=4B，因此每秒25M个4B，每秒就是100MB，即100MBps或者100MB/s。  
提高一倍数据传输率的方法：提高总线宽度到64位，或者时钟频率加到200MHz。

例2 在异步串行传输系统中假设每秒传输 120 个数据帧其字符格式规定包含1个起始位7个数据位，1个奇校验位，1个终止位。试计算波特率。  
**波特率**是指：每秒钟传的二进制位数。单位bps，即bit/s，不管是数据位还是添加的校验位都算。  
每秒120个数据帧，每个数据帧10bit，每秒就是1200bit， 答案1200bps。  

例3 在异步串行传输系统中若字符格式为: 1 位起始位 ，8 位数据位，1 位奇校验位， 1 位终止位，假设波特率为 1200 bps，求这时的比特率。
(**比特率**：单位时间内传送二进制有效数据的位数)  
波特率1200bps，一个数据单元11bit， 所以每秒钟的数据单元数是1200除以11，而每个数据单元中，真正的有效数据8位，所以再乘以8，即 9600/11 bps。

例4 某同步总线采用地址线和数据线复用方式，其中地址/数据线有32根，总线时钟频率为66MHz，每个时钟周期传送两次数据（上升沿和下降沿各传送一次数据），该总线的最大数据传输率（总线带宽）是（）  （本来是选择题）   
时钟频率66MHz，即 66M 个周期/秒， 数据传输2次/周期， 每次传输因为32根线， 传输的数据量4B/次， 所以 $\frac{66M 周期}{1s}\cdot\frac{2{次}}{1{周期}}\cdot\frac{4B}{1{次}}=528M/s$ 单位约掉，就能得到答案。

例5 假定一台计算机采用3通道存储器总线，配套内存条型号为DDR3-1333，即内存条所接插的存储器总线的工作频率为1333MHz，总线宽度为64位，则存储器总线的总带宽大约是（）
（选择题，选项有32GB）  
分析： 题目写3通道，就把单通道的带宽算完乘3，没有说时钟频率或传输周期，直接说工作频率，就是1秒传输1333M次，答案可以直接用1333×8×3得到。  


